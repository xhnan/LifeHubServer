name: CI/CD Pipeline (Self-Hosted Local)

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

env:
  JAVA_VERSION: "17"
  DEPLOY_PATH: /usr/local/lifehub/server # ä½ çš„éƒ¨ç½²ç›®å½•
  LOCAL_IMAGE_NAME: lifehubserver:local  # çº¯æœ¬åœ°é•œåƒåï¼Œä¸å¸¦ registry å‰ç¼€

jobs:
  # ============================================================
  # æ„å»ºã€æ‰“åŒ…å¹¶ç›´æ¥éƒ¨ç½² (çº¯æœ¬åœ°é—­ç¯)
  # ============================================================
  build-and-deploy:
    name: ğŸš€ Build & Deploy
    runs-on: [self-hosted]

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      # 1. ç¼–è¯‘ Java (é€‚ç”¨äºæ‰€æœ‰åˆ†æ”¯ï¼Œä½œä¸º CI æµ‹è¯•)
      - name: â˜• Build Package
        run: |
          echo "Building Java project..."
          mvn clean package -DskipTests -B

      # 2. æœ¬åœ°æ„å»º Docker é•œåƒ (ä»… main åˆ†æ”¯)
      - name: ğŸ³ Build Local Docker Image
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          echo "Building Docker image locally..."
          # ç›´æ¥åœ¨æœ¬åœ°æ‰“åŒ…å¹¶æ‰“ä¸Š local æ ‡ç­¾
          docker build -t ${{ env.LOCAL_IMAGE_NAME }} .

      # 3. å°±åœ°éƒ¨ç½² (ä»… main åˆ†æ”¯)
      - name: ğŸš€ Deploy to Production
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          echo "ğŸ“‚ è¿›å…¥éƒ¨ç½²ç›®å½•..."
          cd ${{ env.DEPLOY_PATH }}

          echo "â™»ï¸ é‡å¯æœåŠ¡..."
          # docker-compose ä¼šè‡ªåŠ¨è¯»å–æˆ‘ä»¬ä¸Šé¢æ”¹å¥½çš„é…ç½®ï¼Œæ‹‰èµ· lifehubserver:local
          docker compose up -d --remove-orphans

          echo "ğŸ§¹ æ¸…ç†æ—§é•œåƒ..."
          docker image prune -f

          echo "âœ… éƒ¨ç½²å®Œæˆï¼å½“å‰è¿è¡ŒçŠ¶æ€ï¼š"
          docker compose ps
