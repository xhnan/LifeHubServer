name: CI/CD Pipeline (Self-Hosted Local)

on:
  push:
    branches:
      - main
      - develop

env:
  DEPLOY_PATH: /usr/local/lifehub/server
  LOCAL_IMAGE_NAME: lifehubserver:local

jobs:
  build-and-deploy:
    name: ğŸš€ Build & Deploy
    runs-on: [self-hosted]

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      # ğŸŒŸ åˆ æ‰äº†æœ¬åœ°çš„ mvn clean package æ­¥éª¤ï¼Œç›´æ¥è¿›å…¥ Docker æ„å»º
      # Dockerfile é‡Œé¢çš„ builder é˜¶æ®µä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬ä¸‹è½½ä¾èµ–å¹¶ç¼–è¯‘

      - name: ğŸ³ Build Local Docker Image
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          echo "Building Docker image locally..."
          # è®© Docker å»å¤„ç†ä¸€åˆ‡ï¼ˆç¼–è¯‘ + æ‰“åŒ…é•œåƒï¼‰
          docker build -t ${{ env.LOCAL_IMAGE_NAME }} .

      - name: ğŸš€ Deploy to Production
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          echo "ğŸ“‚ è¿›å…¥éƒ¨ç½²ç›®å½•..."
          cd ${{ env.DEPLOY_PATH }}

          echo "â™»ï¸ é‡å¯æœåŠ¡..."
          docker compose up -d --remove-orphans

          echo "ğŸ§¹ æ¸…ç†æ—§é•œåƒ..."
          docker image prune -f

          echo "âœ… éƒ¨ç½²å®Œæˆï¼"
          docker compose ps