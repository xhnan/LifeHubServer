version: "3.9"

services:
  lifehub-server:
    image: ${DOCKER_IMAGE:-lifehubserver:latest}
    container_name: lifehub-server
    restart: unless-stopped
    ports:
      - "9000:9000"
    environment:
      # Spring Profile（prod 环境启用 Nacos）
      SPRING_PROFILES_ACTIVE: prod

      # ---- Nacos 连接信息（从 .env 注入）----
      # Nacos 与应用同处一台服务器，使用 host.docker.internal 访问宿主机
      # （容器内 localhost 指容器自身，不能直接访问宿主机服务）
      NACOS_SERVER_ADDR: ${NACOS_SERVER_ADDR:-host.docker.internal:8848}
      NACOS_NAMESPACE: ${NACOS_NAMESPACE:-}
      NACOS_USERNAME: ${NACOS_USERNAME:-nacos}
      NACOS_PASSWORD: ${NACOS_PASSWORD:-nacos}
    extra_hosts:
      # 将 host.docker.internal 映射到宿主机 IP（Docker 20.10+ 支持 host-gateway）
      # 这样容器内可以通过 host.docker.internal 访问宿主机上的 Nacos、数据库等服务
      - "host.docker.internal:host-gateway"
    volumes:
      # 容器内 /app/logs → 服务器 /usr/local/lifehub/server/log
      - /usr/local/lifehub/server/log:/app/logs
    networks:
      - lifehub-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

networks:
  lifehub-net:
    driver: bridge
