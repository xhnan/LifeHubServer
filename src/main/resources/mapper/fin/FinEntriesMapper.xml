<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xhn.fin.entries.mapper.FinEntriesMapper">

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id, trans_id, account_id, direction, amount, quantity, price, commodity_code
    </sql>

    <!-- 统计本月收入总额 -->
    <!-- 收入 = 收入科目(INCOME)的贷方金额 - 借方金额 -->
    <select id="sumIncomeByMonth" resultType="java.math.BigDecimal">
        SELECT COALESCE(SUM(
            CASE 
                WHEN e.direction = 'CREDIT' THEN e.amount 
                WHEN e.direction = 'DEBIT' THEN -e.amount 
                ELSE 0 
            END
        ), 0) AS total_income
        FROM fin_entries e
        INNER JOIN fin_accounts a ON e.account_id = a.id
        INNER JOIN fin_transactions t ON e.trans_id = t.id
        WHERE a.account_type = 'INCOME'
          AND e.book_id = #{bookId}
          AND t.trans_date >= #{monthStart}
          AND t.trans_date &lt;= #{monthEnd}
    </select>

    <!-- 统计本月支出总额 -->
    <!-- 支出 = 支出科目(EXPENSE)的借方金额 - 贷方金额 -->
    <select id="sumExpenseByMonth" resultType="java.math.BigDecimal">
        SELECT COALESCE(SUM(
            CASE 
                WHEN e.direction = 'DEBIT' THEN e.amount 
                WHEN e.direction = 'CREDIT' THEN -e.amount 
                ELSE 0 
            END
        ), 0) AS total_expense
        FROM fin_entries e
        INNER JOIN fin_accounts a ON e.account_id = a.id
        INNER JOIN fin_transactions t ON e.trans_id = t.id
        WHERE a.account_type = 'EXPENSE'
          AND e.book_id = #{bookId}
          AND t.trans_date >= #{monthStart}
          AND t.trans_date &lt;= #{monthEnd}
    </select>

    <!-- 统计指定账本的资产类科目余额合计 -->
    <!-- 资产余额 = 初始余额 + 借方金额 - 贷方金额 -->
    <select id="sumAssetBalance" resultType="java.math.BigDecimal">
        SELECT COALESCE(
            (SELECT COALESCE(SUM(a.initial_balance), 0)
             FROM fin_accounts a
             WHERE a.account_type = 'ASSET'
               AND a.is_archived = false
               AND a.is_leaf = true
               AND a.book_id = #{bookId})
            +
            (SELECT COALESCE(SUM(
                CASE
                    WHEN e.direction = 'DEBIT' THEN e.amount
                    WHEN e.direction = 'CREDIT' THEN -e.amount
                    ELSE 0
                END
            ), 0)
             FROM fin_entries e
             INNER JOIN fin_accounts a ON e.account_id = a.id
             WHERE a.account_type = 'ASSET'
               AND e.book_id = #{bookId})
        , 0)
    </select>

    <!-- 统计指定账本的负债类科目余额合计 -->
    <!-- 负债余额 = 初始余额 + 贷方金额 - 借方金额 -->
    <select id="sumLiabilityBalance" resultType="java.math.BigDecimal">
        SELECT COALESCE(
            (SELECT COALESCE(SUM(a.initial_balance), 0)
             FROM fin_accounts a
             WHERE a.account_type = 'LIABILITY'
               AND a.is_archived = false
               AND a.is_leaf = true
               AND a.book_id = #{bookId})
            +
            (SELECT COALESCE(SUM(
                CASE
                    WHEN e.direction = 'CREDIT' THEN e.amount
                    WHEN e.direction = 'DEBIT' THEN -e.amount
                    ELSE 0
                END
            ), 0)
             FROM fin_entries e
             INNER JOIN fin_accounts a ON e.account_id = a.id
             WHERE a.account_type = 'LIABILITY'
               AND e.book_id = #{bookId})
        , 0)
    </select>

    <!-- 按科目分组统计每个科目的净变动额（借方 - 贷方） -->
    <select id="sumBalanceChangeByAccount" resultType="java.util.Map">
        SELECT e.account_id,
               COALESCE(SUM(
                   CASE
                       WHEN e.direction = 'DEBIT' THEN e.amount
                       WHEN e.direction = 'CREDIT' THEN -e.amount
                       ELSE 0
                   END
               ), 0) AS net_amount
        FROM fin_entries e
        WHERE e.book_id = #{bookId}
        GROUP BY e.account_id
    </select>

</mapper>